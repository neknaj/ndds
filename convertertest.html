<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NDDS Converter Test</title>
    <link href="./defaultmodule/default.css" rel="stylesheet">
    <script src="cdom.js"></script>
</head>
<body>
    <h1>Neknaj Document Description System Converter Test</h1>
    <h2>入力</h2>
    <textarea id="input" spellcheck="none"></textarea>
    <button onclick="convert()">変換</button>
    <h2>結果</h2>
    <div id="output" class="NDDS"></div>
</body>
</html>
<script>module={}</script>
<script src="./parser/lineparser.js"></script>
<script>const lineparser = module.exports.parse;</script>
<script>

Array.prototype.last = function(n=1) {
    return this[this.length-n];
};

document.getElementById('input').value = document.getElementById('input').value==""?fRead("./doc.nml"):document.getElementById('input').value;

var Runtime = {};
var Module = {};

function convert() {
    let input = document.getElementById('input').value+"\n";
    output.innerHTML = "";
    converter(input,output);
}

function converter(input,parent) {
    let inputlines = input.split("\n");
    let lastLn = inputlines.length;
    console.log(lastLn)
    let nestList = [parent];
    for (let ln=1;ln<lastLn;ln++) {
        // line.indentがある場合、nestListにdiv要素を追加する (">>>" )
        {
            let newindent = countIndent(inputlines,ln);
            console.log("indent",newindent)
            console.log(newindent,nestList.length-1)
            while (newindent<nestList.length-1) {
                console.log("decr")
                nestList.pop();
            }
        }
        let line = lineparser(input,{line:ln,col:(nestList.length-1)*4});
        console.log(line)
        if (line.indent==">>> ") { // インデント追加
            let newelm = elm("div",{class:["nest"]},[]);
            nestList.last().Add(newelm);
            nestList.push(newelm);
        }
        Runtime.NMLLine(line,Module,nestList.last());
        if ((line.linebreak&&line.res.length!=0)||(!line.linebreak&&line.res.length==0)) {
            nestList.last().Add(elm("br",{},[]));
        }
    }
}
function countIndent(ils,ln) {
    let i = 0;
    while (ils[ln-1][i]==" ") {i++;}
    return i/4;
}

import('./runtime/eval.js').then(module => {
        console.log(module);
        Runtime = module;
    }).catch(error => {
        console.error('Error loading module:', error);
    });
import('./defaultmodule/default.js').then(module => {
        console.log(module);
        Module.default = module;
    }).catch(error => {
        console.error('Error loading module:', error);
    });
function fRead(filename) {
    var hr = new XMLHttpRequest();
    hr.open("GET", filename, false);
    hr.send(null);
    if (hr.status == 200 || hr.status == 304) {
        return hr.responseText.replace(/\r\n/g, "\n");
    }
    else {
        throw "err " + filename;
    }
};
</script>
<style>
    :root {
        color-scheme: dark;
    }
    body {
        font-family: serif;
        max-width: 1500px;
        margin: 0 auto;
        padding: 20px;
        background: rgb(0, 0, 15);
    }
    textarea {
        background-color: black;
        width: 100%;
        height: 250px;
        padding: 5px;
    }
    input[type="number"] {
        width: 50px;
    }
    #output {
        background-color: black;
        border: 1px solid;
        padding: 15px;
    }
</style>